# 関数電卓

Java と Swing で実装したデスクトップ向けの関数電卓アプリです。  
標準的な四則演算に加えて、累乗・平方根・対数・階乗などの関数をサポートしています。

---

## アプリ概要

- Java 21 + Swing のみで動作するスタンドアロンアプリ
- 電卓っぽい見た目の UI（上部に表示エリア、下部にボタン）
- 通常の電卓としても、関数電卓としても使えるような構成を目指しました

---

## 機能紹介

### 1. 表示エリア

- 上段：計算結果表示（`resultField`）
  - 桁数が増えた時は自動でフォントサイズを縮小
  - 整数なら「1,234」、小数なら「1,234.5678」のように桁区切りで表示
- 下段：2つのサブ表示（`subField` / `exprField`）
  - 右側：入力中の数式を表示
  - 左側：直前に計算した式を短く表示（長すぎる場合は途中でカット）

### 2. 基本的な計算機能

- 数値入力：`0～9`、小数点 `.`
- 四則演算：`+` `-` `×` `÷`
- 括弧：`(` `)` を使った優先順位付きの計算
- イコール `=`：現在の式を評価して結果を表示
- クリア `C`：
  - 入力中の式、サブ表示、結果表示をすべて初期化
- バックスペース `⌫`：
  - 1文字だけ削除

### 3. 関数ボタン

以下のような関数に対応しています。

- `x²`：2乗  
- `¹/x`：逆数  
- `²√x`：平方根  
- `exp`：指数関数（e^x）  
- `log`：常用対数（log10）  
- `ln`：自然対数（ln）  
- `10ˣ`：10 の x 乗  
- `n!`：階乗（整数のみ）  
- `|x|`：絶対値  
- `+/-`：符号反転  
- `mod`：剰余（a mod b）  
- `xʸ`：べき乗（x^y）

### 4. 定数

- `π`：円周率（Math.PI）
  - 「3π」のような形で入力された場合は掛け算として扱う
- `e`：自然対数の底（Math.E）
  - 「2e」のような形で入力された場合は掛け算として扱う

### 5. 連続計算（前回結果を利用）

- `lastResult` という変数で直前の計算結果を保持
- 入力欄が空の状態で  
  `+ 5` や `× 2` のように演算子から入力を始めると  
  「前回の結果 ○○ を使って計算を続ける」動きになります

例）  
1. `2 + 3 =` → 結果 5  
2. そのまま `× 4 =` → 直前の 5 を使って 20 を計算

---

## 内部実装のポイント

### 1. 中置記法 → 逆ポーランド記法（RPN）変換

`CalcEngine` クラス側で、以下の流れで式を評価しています。

1. UI から渡された文字列の式を、演算子や関数記号に変換  
   - `×` → `*`  
   - `÷` → `/`  
   - 関数名を内部用のトークンに変換（`x²` → `square` など）
2. 正規表現でトークンに分割（数値・演算子・括弧など）
3. 先頭のマイナスや「演算子の直後のマイナス」を単項マイナスとして扱う
4. シャントイエード法のようなイメージで  
   中置記法 → 逆ポーランド記法（RPN）に変換
5. スタックを使って RPN を評価し、最終結果を返す

これにより、括弧や複数の演算子が混ざった式でも柔軟に計算できます。

### 2. 単項マイナス（-x）の扱い

- 先頭の `-` や、演算子／`(` の直後の `-` は  
  2項演算ではなく「符号反転（neg）」として置き換えています。
- 評価時には `neg` トークンが来たらスタックの一番上を `-1` 倍する形で実装。

### 3. フォントサイズの自動調整

`adjustFontToFit(JTextField field)` メソッドで以下を実施：

- 現在の文字列の表示幅（px）を `FontMetrics` で計測
- テキストフィールドの横幅と比較し、はみ出しそうなら文字サイズを縮小
- 小さくなりすぎないようにフォントサイズの下限値（12px）を設定

これにより、桁数が多い計算結果でもレイアウトが崩れにくくなっています。

---
